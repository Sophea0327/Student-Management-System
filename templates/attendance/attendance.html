{% extends "layout.html" %}
{% block title %}Attendance Management{% endblock %}

{% block content %}
<h2 class="mb-4 text-primary fw-bold">ðŸ—“ Attendance Management</h2>

<form action="{{ url_for('attendance_routes.mark_attendance') }}" method="POST" id="attendanceForm">
  <div class="mb-3">
    <label for="class_id" class="form-label">Select Class</label>
    <select name="class_id" id="class_id" class="form-select" required>
      <option value="">-- Select Class --</option>
      {% for c in classes %}
        <option value="{{ c.id }}">{{ c.name }}</option>
      {% endfor %}
    </select>
  </div>

  <div id="studentList" class="card p-3 shadow-sm" style="display: none;">
    <h5 class="mb-3 text-secondary">Students</h5>
    <table class="table table-bordered">
      <thead>
        <tr>
          <th>Student Name</th>
          <th class="text-center">Present</th>
          <th class="text-center">Absent</th>
          <th class="text-center">Late</th>
        </tr>
      </thead>
      <tbody id="studentsTableBody"></tbody>
    </table>

    <button type="submit" class="btn btn-success">Save Attendance</button>
  </div>
</form>

<hr>

<h4 class="mt-4 text-info">ðŸ“‹ Attendance Records</h4>
<table class="table table-striped mt-2">
  <thead>
    <tr>
      <th>Date</th>
      <th>Student Name</th>
      <th>Class</th>
      <th>Status</th>
    </tr>
  </thead>
  <tbody>
    {% for a in attendance %}
    <tr>
      <td>{{ a.date }}</td>
      <td>{{ a.student_name }}</td>
      <td>{{ a.class_name }}</td>
      <td>
        {% if a.status == 'Present' %}
          <span class="badge bg-success">{{ a.status }}</span>
        {% elif a.status == 'Absent' %}
          <span class="badge bg-danger">{{ a.status }}</span>
        {% else %}
          <span class="badge bg-warning text-dark">{{ a.status }}</span>
        {% endif %}
      </td>
    </tr>
    {% endfor %}
  </tbody>
</table>

<script>
document.getElementById('class_id').addEventListener('change', async function() {
  const classId = this.value;
  const studentList = document.getElementById('studentList');
  const tbody = document.getElementById('studentsTableBody');
  tbody.innerHTML = '';

  if (classId) {
    const res = await fetch(`/attendance/students/${classId}`);
    const data = await res.json();

    if (data.students.length > 0) {
      studentList.style.display = 'block';
      data.students.forEach(s => {
        tbody.innerHTML += `
          <tr>
            <td>
              <input type="hidden" name="student_id" value="${s.id}">
              ${s.name}
            </td>
            <td class="text-center"><input type="radio" name="status" value="Present" required></td>
            <td class="text-center"><input type="radio" name="status" value="Absent"></td>
            <td class="text-center"><input type="radio" name="status" value="Late"></td>
          </tr>`;
      });
    } else {
      studentList.style.display = 'none';
      alert('No students found for this class.');
    }
  } else {
    studentList.style.display = 'none';
  }
});
</script>

{% endblock %}
